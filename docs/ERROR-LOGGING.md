# Логирование ошибок

## Обзор

В приложении настроено комплексное логирование ошибок на клиенте и сервере. Все ошибки автоматически отправляются в Grafana Loki для мониторинга и анализа.

## Что логируется

### 1. Ошибки React компонентов

- **ErrorBoundary** - перехватывает и логирует все ошибки рендеринга компонентов
- **global-error.tsx** - логирует критические ошибки приложения
- **error.tsx** - логирует ошибки страниц

**Контекст:**
- Тип ошибки
- Stack trace
- URL страницы
- User Agent
- Digest (если есть)

### 2. Ошибки загрузки данных

- **useOptimizedFetch** - логирует ошибки HTTP запросов
- **CatalogContext** - логирует ошибки загрузки каталога, категорий, брендов, коллекций
- **React Query** - автоматически логирует все ошибки запросов и мутаций

**Контекст:**
- URL запроса
- HTTP статус
- Метод запроса
- Параметры запроса

### 3. Ошибки изображений

- **OptimizedImage** (ui) - логирует ошибки загрузки изображений
- **OptimizedImage** (catalog) - логирует ошибки с fallback изображениями

**Контекст:**
- URL изображения
- Alt текст
- Информация о fallback изображениях

### 4. Ошибки форм

- **ContactForm** - логирует ошибки отправки формы контактов

**Контекст:**
- Данные формы (без чувствительной информации)
- Тип ошибки

### 5. Ошибки API

- **/api/contact** - логирует ошибки обработки контактных форм
- **/api/catalog/products** - логирует ошибки получения продуктов
- **/api/admin/products** - логирует ошибки админ-панели

**Контекст:**
- Endpoint
- Метод запроса
- Параметры запроса
- Время выполнения
- Детали ошибки

## Уровни логирования

- **error** - Критические ошибки, требующие внимания
- **warn** - Предупреждения (например, fallback изображений)
- **info** - Информационные сообщения (успешные операции)
- **http** - HTTP запросы
- **debug** - Детальная информация для разработки

## Просмотр логов

### В Grafana

1. Откройте Grafana: http://localhost:3001
2. Перейдите в **Explore**
3. Выберите источник данных **Loki**
4. Используйте запросы:

```logql
# Все ошибки
{app="company-site-next", level="error"}

# Ошибки загрузки данных
{app="company-site-next", level="error"} |= "fetch-error"

# Ошибки изображений
{app="company-site-next", level="error"} |= "image-load-error"

# Ошибки форм
{app="company-site-next", level="error"} |= "contact-form-error"

# Ошибки API
{app="company-site-next", level="error"} |= "api-error"

# React Query ошибки
{app="company-site-next", level="error"} |= "react-query-error"
```

### В консоли разработчика

В режиме разработки все логи также выводятся в консоль браузера.

## Структура логов

Каждый лог содержит:

```json
{
  "level": "error",
  "message": "Описание ошибки",
  "error": {
    "message": "Сообщение об ошибке",
    "stack": "Stack trace",
    "name": "Error"
  },
  "context": {
    "errorType": "тип-ошибки",
    "component": "название-компонента",
    "url": "URL запроса",
    "method": "HTTP метод",
    // ... дополнительные поля
  },
  "timestamp": "2025-12-17T15:43:20.123Z"
}
```

## Мониторинг

### Рекомендуемые алерты в Grafana

1. **Критические ошибки** - более 10 ошибок за 5 минут
2. **Ошибки API** - более 5 ошибок API за минуту
3. **Ошибки загрузки** - более 20 ошибок загрузки за 5 минут
4. **Ошибки изображений** - более 50 ошибок загрузки изображений за минуту

## Лучшие практики

1. **Не логируйте чувствительные данные** - пароли, токены, персональные данные
2. **Используйте правильный уровень** - error для критических, warn для предупреждений
3. **Добавляйте контекст** - URL, параметры запроса, состояние компонента
4. **Группируйте похожие ошибки** - используйте errorType для фильтрации

## Добавление нового логирования

### На клиенте

```typescript
import { clientLogger } from '@/lib/logger/client';

try {
  // код
} catch (error) {
  clientLogger.error('Описание ошибки', error, {
    errorType: 'тип-ошибки',
    component: 'название-компонента',
    // дополнительный контекст
  });
}
```

### На сервере

```typescript
import { logError, logInfo, logHttp } from '@/lib/logger/server';

try {
  logHttp('Описание запроса', { endpoint: '/api/endpoint' });
  // код
  logInfo('Успешная операция', { duration: '100ms' });
} catch (error) {
  logError('Описание ошибки', error, {
    endpoint: '/api/endpoint',
    errorType: 'тип-ошибки',
  });
}
```

## Отключение логирования

Для отключения логирования в определенных окружениях, установите переменную окружения:

```env
LOG_LEVEL=warn  # Логировать только warn и error
# или
LOG_LEVEL=error  # Логировать только error
```

