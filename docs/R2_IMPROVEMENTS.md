# R2 Storage Improvements & Next.js 15 Compatibility Fixes

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ —É–ª—É—á—à–µ–Ω–∏—è, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –≤ —Å–∏—Å—Ç–µ–º–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ Cloudflare R2 –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Next.js 15.

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è "0" –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ UUID —Ç–æ–≤–∞—Ä–∞.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω `getRowId: (row) => row.id` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é `useReactTable`
- –¢–µ–ø–µ—Ä—å —Ç–∞–±–ª–∏—Ü–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç UUID —Ç–æ–≤–∞—Ä–æ–≤ –≤–º–µ—Å—Ç–æ –∏–Ω–¥–µ–∫—Å–æ–≤ —Å—Ç—Ä–æ–∫

**–§–∞–π–ª—ã**:
- `src/components/admin/ProductManagerClient.tsx`

### 2. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Next.js 15
**–ü—Ä–æ–±–ª–µ–º–∞**: –í Next.js 15 –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤ API –º–∞—Ä—à—Ä—É—Ç–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ**:
- –ò–∑–º–µ–Ω–µ–Ω —Ç–∏–ø –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å `{ params: { id: string } }` –Ω–∞ `{ params: Promise<{ id: string }> }`
- –î–æ–±–∞–≤–ª–µ–Ω `await` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∫ `params`

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**:
- `src/app/api/admin/products/[productId]/route.ts`
- `src/app/api/admin/users/[id]/route.ts`
- `src/app/api/files/[key]/route.ts`
- `src/app/api/products/[slug]/route.ts`

### 3. –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ –≤ R2

**–°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**:
```
images/
‚îú‚îÄ‚îÄ file1.jpg
‚îú‚îÄ‚îÄ file2.png
‚îî‚îÄ‚îÄ ...

documents/
‚îú‚îÄ‚îÄ doc1.pdf
‚îî‚îÄ‚îÄ ...
```

**–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**:
```
images/
‚îú‚îÄ‚îÄ products/
‚îÇ   ‚îú‚îÄ‚îÄ 1703123456789_a1b2c3d4e5f6_product_image.jpg
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ categories/
‚îú‚îÄ‚îÄ brands/
‚îú‚îÄ‚îÄ collections/
‚îú‚îÄ‚îÄ users/
‚îî‚îÄ‚îÄ avatars/

documents/
‚îú‚îÄ‚îÄ products/
‚îú‚îÄ‚îÄ categories/
‚îú‚îÄ‚îÄ legal/
‚îî‚îÄ‚îÄ manuals/

specifications/
‚îú‚îÄ‚îÄ products/
‚îî‚îÄ‚îÄ technical/

temp/
```

## üõ† –ù–æ–≤–∞—è —É—Ç–∏–ª–∏—Ç–∞ R2

### –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
`src/utils/r2/client.ts`

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### `uploadFileToR2(file, folder)`
–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –ø–∞–ø–∫—É —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ–º:
```typescript
const url = await uploadFileToR2(file, 'images/products');
```

#### `deleteFileFromR2(fileUrl)` 
–£–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª –ø–æ –ø—É–±–ª–∏—á–Ω–æ–º—É URL:
```typescript
await deleteFileFromR2('https://cdn.example.com/images/products/file.jpg');
```

#### `deleteMultipleFilesFromR2(fileUrls)`
–£–¥–∞–ª—è–µ—Ç –º–∞—Å—Å–∏–≤ —Ñ–∞–π–ª–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
```typescript
await deleteMultipleFilesFromR2([url1, url2, url3]);
```

#### `extractR2KeyFromUrl(fileUrl)`
–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á –æ–±—ä–µ–∫—Ç–∞ –∏–∑ URL:
```typescript
const key = extractR2KeyFromUrl('https://cdn.example.com/images/products/file.jpg');
// –†–µ–∑—É–ª—å—Ç–∞—Ç: 'images/products/file.jpg'
```

### –¢–∏–ø—ã –ø–∞–ø–æ–∫ (R2Folder)
```typescript
type R2Folder = 
  | "images/products"
  | "images/categories" 
  | "images/brands"
  | "images/collections"
  | "images/users"
  | "images/avatars"
  | "documents/products"
  | "documents/categories"
  | "documents/legal"
  | "documents/manuals"
  | "specifications/products"
  | "specifications/technical"
  | "temp";
```

## üîß –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

### –°—Ö–µ–º–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
```
{timestamp}_{randomString}_{sanitizedOriginalName}
```

### –ü—Ä–∏–º–µ—Ä
```
1703123456789_a1b2c3d4e5f6_product_image.jpg
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏–º–µ–Ω–∏
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—É–¥–∞–ª–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤)

## üìÇ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ API –º–∞—Ä—à—Ä—É—Ç—ã

### –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
**–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**: `images/products/`
```typescript
const imageUrl = await uploadFileToR2(imageFile, 'images/products');
```

**–î–æ–∫—É–º–µ–Ω—Ç—ã**: `documents/products/`
```typescript
const docUrl = await uploadFileToR2(docFile, 'documents/products');
```

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏**: `specifications/products/`
```typescript
const specUrl = await uploadFileToR2(specFile, 'specifications/products');
```

### –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
```typescript
const filesToDelete = [
  ...product.images,
  ...product.documents.map(doc => doc.url),
  ...product.specifications.map(spec => spec.url)
];
await deleteMultipleFilesFromR2(filesToDelete);
```

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–∞ –∏–∑ URL
**–ë—ã–ª–æ**: –ü—Ä–æ—Å—Ç–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–ª—ç—à–∞
```typescript
const key = url.pathname.substring(1);
```

**–°—Ç–∞–ª–æ**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ URL
```typescript
const key = fileUrl.substring(baseUrl.length + 1);
```

### 2. –û—à–∏–±–∫–∏ —Ç–∏–ø–æ–≤ TypeScript
- –ó–∞–º–µ–Ω–µ–Ω—ã `any` —Ç–∏–ø—ã –Ω–∞ –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ —Ç–∏–ø—ã
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### 3. –ü—Ä–æ–±–ª–µ–º—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ Next.js 15
- –í—Å–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è async params
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ç–∏–ø—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ API routes

## üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```env
CLOUDFLARE_R2_ACCOUNT_ID=your_account_id
CLOUDFLARE_R2_ACCESS_KEY_ID=your_access_key
CLOUDFLARE_R2_SECRET_ACCESS_KEY=your_secret_key
CLOUDFLARE_R2_BUCKET_NAME=your_bucket_name
CLOUDFLARE_R2_PUBLIC_URL=https://your-bucket.your-account.r2.cloudflarestorage.com
CLOUDFLARE_R2_CUSTOM_DOMAIN=https://your-custom-domain.com # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤

–î–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤ –∏–∑ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ –Ω–æ–≤—É—é:

1. –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
2. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞–ø–∫–∏
3. –û–±–Ω–æ–≤–∏—Ç—å URL –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
4. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã

–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –≤ `src/utils/r2/README.md`

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ UUID –≤–º–µ—Å—Ç–æ –∏–Ω–¥–µ–∫—Å–æ–≤
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Next.js 15
- ‚úÖ –û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –≤ R2
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

### –£–ª—É—á—à–µ–Ω–æ
- üöÄ –ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- üîí –õ—É—á—à–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤
- üìÅ –õ–æ–≥–∏—á–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- üõ† –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —É—Ç–∏–ª–∏—Ç—ã
- üìö –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞**:
   - API –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –≤ `images/categories/`
   - API –¥–ª—è –±—Ä–µ–Ω–¥–æ–≤ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –≤ `images/brands/`
   - API –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–π —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –≤ `images/collections/`

2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**:
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Sharp –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∂–∞—Ç–∏—è
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
   - WebP –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–∞–º–∏
   - –ú–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è storage
   - Alerts –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - CDN –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É! üéâ