-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.brands (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL CHECK (length(TRIM(BOTH FROM name)) >= 2),
  slug text NOT NULL CHECK (slug ~ '^[a-z0-9\-]+$'::text),
  description text,
  logo_url text,
  website text,
  country text,
  is_active boolean NOT NULL DEFAULT true,
  sort_order integer NOT NULL DEFAULT 0 CHECK (sort_order >= 0),
  meta_title text,
  meta_description text,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT brands_pkey PRIMARY KEY (id)
);
CREATE TABLE public.categories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL CHECK (length(TRIM(BOTH FROM name)) >= 2),
  slug text NOT NULL CHECK (slug ~ '^[a-z0-9\-]+$'::text),
  description text,
  parent_id uuid,
  level integer NOT NULL DEFAULT 0 CHECK (level >= 0 AND level <= 5),
  path text NOT NULL,
  image_url text,
  icon_name text,
  is_active boolean NOT NULL DEFAULT true,
  sort_order integer NOT NULL DEFAULT 0 CHECK (sort_order >= 0),
  meta_title text,
  meta_description text,
  meta_keywords text,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT categories_pkey PRIMARY KEY (id),
  CONSTRAINT categories_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.categories(id)
);
CREATE TABLE public.collections (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL CHECK (length(TRIM(BOTH FROM name)) >= 2),
  slug text NOT NULL CHECK (slug ~ '^[a-z0-9\-]+$'::text),
  description text,
  brand_id uuid,
  category_id uuid,
  image_url text,
  is_active boolean NOT NULL DEFAULT true,
  sort_order integer NOT NULL DEFAULT 0 CHECK (sort_order >= 0),
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT collections_pkey PRIMARY KEY (id),
  CONSTRAINT collections_brand_id_fkey FOREIGN KEY (brand_id) REFERENCES public.brands(id),
  CONSTRAINT collections_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.categories(id)
);
CREATE TABLE public.companies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL CHECK (length(TRIM(BOTH FROM name)) >= 2),
  bin text UNIQUE CHECK (bin IS NULL OR length(bin) = 12),
  legal_address text,
  phone text,
  email text CHECK (email IS NULL OR email ~* '^[A-Za-z0-9._%-]+@[A-Za-z0-9.-]+[.][A-Za-z]+$'::text),
  website text,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT companies_pkey PRIMARY KEY (id)
);
CREATE TABLE public.currencies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code text NOT NULL UNIQUE CHECK (length(code) = 3 AND code = upper(code)),
  name text NOT NULL CHECK (length(TRIM(BOTH FROM name)) >= 2),
  symbol text NOT NULL,
  exchange_rate numeric NOT NULL DEFAULT 1.0 CHECK (exchange_rate > 0::numeric),
  is_base boolean NOT NULL DEFAULT false,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT currencies_pkey PRIMARY KEY (id)
);
CREATE TABLE public.product_variants (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id uuid NOT NULL,
  name text NOT NULL CHECK (length(TRIM(BOTH FROM name)) >= 1),
  sku text,
  barcode text,
  price_adjustment numeric NOT NULL DEFAULT 0.00,
  inventory_quantity integer NOT NULL DEFAULT 0 CHECK (inventory_quantity >= 0),
  attributes jsonb NOT NULL DEFAULT '{}'::jsonb,
  images ARRAY DEFAULT '{}'::text[],
  is_active boolean NOT NULL DEFAULT true,
  sort_order integer NOT NULL DEFAULT 0 CHECK (sort_order >= 0),
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT product_variants_pkey PRIMARY KEY (id),
  CONSTRAINT product_variants_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id)
);
CREATE TABLE public.products (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL CHECK (length(TRIM(BOTH FROM name)) >= 2),
  slug text NOT NULL CHECK (slug ~ '^[a-z0-9\-]+$'::text),
  sku text,
  barcode text,
  short_description text,
  description text,
  technical_description text,
  category_id uuid NOT NULL,
  brand_id uuid,
  collection_id uuid,
  base_price numeric NOT NULL,
  sale_price numeric,
  cost_price numeric,
  currency_id uuid NOT NULL,
  track_inventory boolean NOT NULL DEFAULT true,
  inventory_quantity integer NOT NULL DEFAULT 0 CHECK (inventory_quantity >= 0),
  min_stock_level integer NOT NULL DEFAULT 0 CHECK (min_stock_level >= 0),
  allow_backorder boolean NOT NULL DEFAULT false,
  weight numeric,
  dimensions jsonb,
  images ARRAY NOT NULL DEFAULT '{}'::text[],
  thumbnail text,
  documents ARRAY DEFAULT '{}'::jsonb[],
  specifications jsonb NOT NULL DEFAULT '{}'::jsonb,
  status USER-DEFINED NOT NULL DEFAULT 'draft'::product_status,
  is_featured boolean NOT NULL DEFAULT false,
  is_digital boolean NOT NULL DEFAULT false,
  meta_title text,
  meta_description text,
  meta_keywords text,
  sort_order integer NOT NULL DEFAULT 0 CHECK (sort_order >= 0),
  view_count integer NOT NULL DEFAULT 0 CHECK (view_count >= 0),
  sales_count integer NOT NULL DEFAULT 0 CHECK (sales_count >= 0),
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  published_at timestamp with time zone,
  CONSTRAINT products_pkey PRIMARY KEY (id),
  CONSTRAINT products_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.categories(id),
  CONSTRAINT products_collection_id_fkey FOREIGN KEY (collection_id) REFERENCES public.collections(id),
  CONSTRAINT products_currency_id_fkey FOREIGN KEY (currency_id) REFERENCES public.currencies(id),
  CONSTRAINT products_brand_id_fkey FOREIGN KEY (brand_id) REFERENCES public.brands(id)
);
CREATE TABLE public.profiles (
  id uuid NOT NULL,
  first_name text,
  last_name text,
  phone text CHECK (phone IS NULL OR phone ~ '^\+?[0-9\s\-\(\)]+$'::text),
  avatar_url text,
  role USER-DEFINED NOT NULL DEFAULT 'customer'::user_role,
  permissions ARRAY DEFAULT '{}'::text[],
  company_id uuid,
  position text,
  address jsonb DEFAULT '{}'::jsonb,
  timezone text NOT NULL DEFAULT 'Asia/Almaty'::text,
  locale text NOT NULL DEFAULT 'ru-RU'::text,
  last_login_at timestamp with time zone,
  login_count integer NOT NULL DEFAULT 0 CHECK (login_count >= 0),
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT profiles_pkey PRIMARY KEY (id),
  CONSTRAINT profiles_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_profiles (
  id uuid NOT NULL,
  email text NOT NULL,
  first_name text,
  last_name text,
  phone text,
  avatar_url text,
  role USER-DEFINED NOT NULL DEFAULT 'customer'::user_role,
  company_name text,
  position text,
  is_active boolean NOT NULL DEFAULT true,
  permissions ARRAY DEFAULT '{}'::text[],
  last_login_at timestamp with time zone,
  login_count integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT user_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT user_profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);