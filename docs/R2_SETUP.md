# Настройка Cloudflare R2 для загрузки файлов

## Обзор
Этот документ описывает настройку системы загрузки файлов в админ-панели интернет-магазина с использованием Cloudflare R2.

## Требования
- Аккаунт Cloudflare с активированным сервисом R2
- Созданный bucket в R2
- API токены с правами доступа к R2

## Шаг 1: Создание Bucket в Cloudflare R2

1. Войдите в панель Cloudflare
2. Перейдите в раздел R2 Object Storage
3. Создайте новый bucket (например, `asia-ntb`)
4. Настройте публичный доступ для bucket'а
5. Получите публичный URL для доступа к файлам

## Шаг 2: Создание API токенов

1. Перейдите в раздел "My Profile" → "API Tokens"
2. Создайте новый токен с правами:
   - R2:Edit для вашего bucket'а
   - Account:Read для доступа к account ID
3. Сохраните Access Key ID и Secret Access Key

## Шаг 3: Настройка переменных окружения

Добавьте следующие переменные в файл `.env.local`:

```env
# Cloudflare R2 Configuration
CLOUDFLARE_R2_ACCOUNT_ID=your_account_id_here
CLOUDFLARE_R2_ACCESS_KEY_ID=your_access_key_id_here
CLOUDFLARE_R2_SECRET_ACCESS_KEY=your_secret_access_key_here
CLOUDFLARE_R2_BUCKET_NAME=asia-ntb
CLOUDFLARE_R2_PUBLIC_URL=https://pub-1506276de6ac4a07aa6fe582457507c1.r2.dev
```

### Где найти значения:

- **CLOUDFLARE_R2_ACCOUNT_ID**: В URL панели Cloudflare или в настройках R2
- **CLOUDFLARE_R2_ACCESS_KEY_ID**: Из созданного API токена
- **CLOUDFLARE_R2_SECRET_ACCESS_KEY**: Из созданного API токена  
- **CLOUDFLARE_R2_BUCKET_NAME**: Имя созданного bucket'а
- **CLOUDFLARE_R2_PUBLIC_URL**: Публичный URL bucket'а (находится в настройках bucket'а)

## Шаг 4: Проверка конфигурации

После настройки переменных окружения:

1. Перезапустите сервер разработки
2. Откройте админ-панель → Каталог → Товары
3. Нажмите "Добавить товар"
4. Перейдите на вкладку "Медиа"
5. Попробуйте загрузить изображение

## Поддерживаемые форматы файлов

### Изображения:
- JPEG (.jpg, .jpeg)
- PNG (.png)
- WebP (.webp)
- AVIF (.avif)
- GIF (.gif)
- Максимальный размер: 20MB

### Документы:
- PDF (.pdf)
- Microsoft Word (.doc, .docx)
- Microsoft Excel (.xls, .xlsx)
- Текстовые файлы (.txt, .csv)
- Максимальный размер: 50MB

## Структура хранения файлов

Файлы организованы в следующей структуре:

```
bucket/
├── images/
│   └── products/
│       └── 2024/
│           └── 01/
│               └── 15/
│                   └── uuid_filename.jpg
└── documents/
    └── products/
        └── 2024/
            └── 01/
                └── 15/
                    └── uuid_filename.pdf
```

## Функции системы

### Автоматические возможности:
- Генерация уникальных имен файлов с UUID
- Валидация типов и размеров файлов
- Автоматическая организация по датам
- Создание публичных URL для доступа
- Обработка ошибок загрузки

### API эндпоинты:
- `POST /api/admin/products` - создание товара с файлами
- `PUT /api/admin/products` - обновление товара с файлами
- `POST /api/upload` - прямая загрузка файлов (presigned URL)

## Troubleshooting

### Ошибка "Missing required R2 environment variables"
- Проверьте, что все переменные окружения заданы правильно
- Убедитесь, что файл `.env.local` находится в корне проекта
- Перезапустите сервер после изменения переменных

### Ошибка загрузки файлов
- Проверьте права доступа API токена
- Убедитесь, что bucket существует и настроен для публичного доступа
- Проверьте размер и тип загружаемых файлов

### Медленная загрузка
- Cloudflare R2 может иметь задержки в разных регионах
- Рассмотрите использование Cloudflare CDN для ускорения доступа

## Безопасность

- Никогда не коммитьте файл `.env.local` в репозиторий
- Используйте API токены с минимально необходимыми правами
- Регулярно ротируйте API ключи
- Настройте CORS политики для bucket'а при необходимости

## Дополнительные возможности

Система поддерживает:
- Удаление файлов при удалении товаров
- Пакетную загрузку нескольких файлов
- Предпросмотр изображений в админ-панели
- Отображение метаданных документов

## Контакты

При возникновении проблем обратитесь к документации Cloudflare R2 или к разработчику системы.